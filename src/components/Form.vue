<template>
    <div id="task-form">
        <!-- Display test case buttons if there are multiple test cases -->
        <div v-if="testCases.length > 1">
            <button v-for="(test, index) in testCases" :key="index" @click="selectTestCase(index)"
                :class="{ 'active-button': index === selectedTestCase, 'test-case-button': true }">
                Test Case {{ index + 1 }}
            </button>
        </div>

        <!-- Form for creating an Asana task -->
        <form @submit.prevent="createTask">
            <!-- Name field -->
            <div class="form-field">
                <div>
                    <label for="name">Name:<span class="required-star">*</span></label>
                </div>
                <div>
                    <textarea id="name" v-model="name" rows="1" required></textarea>
                </div>
            </div>
            <!-- Case Suite field using Multiselect component -->
            <div class="form-field">
                <label for="case-suite">Case Suite:<span class="required-star">*</span></label>
                <Multiselect v-model="caseSuite" required mode="tags" placeholder="Select options" :searchable="true"
                    :close-on-select="false" :options="caseSuiteOptions" />
            </div>
            <!-- Manual Test Coverage field -->
            <div class="form-field">
                <label for="manual-test-coverage">Manual Test Coverage: <span class="required-star">*</span></label>
                <select id="manual-test-coverage" v-model="manualTestCoverage" required>
                    <option disabled value="">Please select one</option>
                    <option v-for="option in manualTestCoverageOptions" :key="option" :value="option">{{ option }}
                    </option>
                </select>
            </div>
            <!-- Pre-Condition field -->
            <div class="form-field">
                <div>
                    <label for="pre-condition">Pre-Condition:</label>
                </div>
                <div>
                    <textarea id="pre-condition" v-model="preCondition" rows="3"></textarea>
                </div>
            </div>
            <!-- Test Step field -->
            <div class="form-field">
                <div>
                    <label for="test-step">Test Step:<span class="required-star">*</span></label>
                </div>
                <div>
                    <textarea id="test-step" v-model="testStep" rows="7" required></textarea>
                </div>
            </div>
            <!-- Expected Result field -->
            <div class="form-field">
                <div>
                    <label for="expected-result">Expected Result:<span class="required-star">*</span></label>
                </div>
                <div>
                    <textarea id="expected-result" v-model="expectedResult" rows="7" required></textarea>
                </div>
            </div>
            <!-- Manual Test Environment field -->
            <div class="form-field">
                <label for="manual-test-environment">Manual Test Environment:</label>
                <select id="manual-test-environment" v-model="manualTestEnvironment">
                    <option disabled value="">Please select one</option>
                    <option v-for="option in manualTestEnvironmentOptions" :key="option" :value="option">{{ option }}
                    </option>
                </select>
            </div>
            <!-- Case Source field -->
            <div class="form-field">
                <label for="case-source">Case Source:</label>
                <select id="case-source" v-model="caseSource">
                    <option disabled value="">Please select one</option>
                    <option v-for="option in caseSourceOptions" :key="option" :value="option">{{ option }}</option>
                </select>
            </div>
            <!-- Main Ticket field -->
            <div class="form-field">
                <label for="main-ticket">Main Ticket: </label>
                <input id="main-ticket" type="url" v-model="mainTicket" placeholder="asana defect task url" />
            </div>
            <!-- Generated By field -->
            <div class="form-field">
                <label for="generated-by">Generated By:</label>
                <select id="generated-by" v-model="generatedBy">
                    <option disabled value="">Please select one</option>
                    <option v-for="option in generatedByOptions" :key="option" :value="option">{{ option }}</option>
                </select>
            </div>
            <!-- Display spinner while creating a task -->
            <div v-if="isCreateLoading" class="spinner-container">
                <div class="spinner"></div>
                <p>Creating asana ticket...</p>
            </div>
            <div v-else></div> <!-- Properly closed div for v-else -->
             <!-- Button container -->
            <div class="button-container">
                <button type="button" @click="clearLocalStorage">Clear</button>
                <button type="submit" :disabled="isCreateLoading">Create</button>
            </div>
            <!-- Display created task URL -->
            <div>
                <label for="taskUrl">Created Task URL:</label>
                <a :href="taskUrl" target="_blank" v-if="taskUrl">link</a>
            </div>
        </form>
    </div>
</template>
  
<script lang="ts">
/// <reference types="chrome" />


import { defineComponent, ref, watch, onMounted } from 'vue';
import Multiselect from '@vueform/multiselect'
import Navigation from "./Navigation.vue";
import { caseSuiteOptions, manualTestCoverageOptions, manualTestEnvironmentOptions, caseSourceOptions, generatedByOptions } from './AsanaOptions';
import { createAsanaTask } from './AsanaField';


export default defineComponent({
    components: {
        Multiselect,
        Navigation,
    },
    props: {
        testCase: {
            type: String,
            default: '',
        },
        main_ticket: {
            type: String,
            default: '',
        },
        currentTab: String,
    },
    setup(props) {
        const isCreateLoading = ref(false);

        const caseSuite = ref([]);
        const manualTestCoverage = ref('Partial');
        const name = ref('');
        const preCondition = ref('');
        const testStep = ref('');
        const expectedResult = ref('');
        const manualTestEnvironment = ref('STAGE');
        const caseSource = ref('Defect');
        const mainTicket = ref(props.main_ticket);
        const generatedBy = ref('AI');


        const taskUrl = ref<string | null>('');

        interface TestCase {
            name: string;
            preCondition: string;
            testStep: string;
            expectedResult: string;
        }

        const selectedTestCase = ref<number>(0);
        const testCases = ref<TestCase[]>([]);

        const inputText = props.testCase;


        onMounted(() => {
            // load saved taskUrl from chrome.storage.sync on component mount
            chrome.storage.sync.get("taskUrl", (data) => {
                if (data.taskUrl) {
                    taskUrl.value = data.taskUrl;
                } else {
                    taskUrl.value = ''
                }
            });

            // load saved form data from chrome.storage.sync on component mount
            chrome.storage.sync.get(["formData"], (result) => {
                if (result.formData) {
                    //const formData = result.formData || {};
                    const formData = JSON.parse(result.formData) || {};
                    caseSuite.value = Array.isArray(formData.caseSuite) ? formData.caseSuite : [];
                    manualTestCoverage.value = formData.manualTestCoverage;
                    manualTestEnvironment.value = formData.manualTestEnvironment;
                    caseSource.value = formData.caseSource;
                    generatedBy.value = formData.generatedBy;
                    getTestCase();
                    selectTestCase(0);
                } else {
                    getTestCase();
                    selectTestCase(0);
                    mainTicket.value = props.main_ticket;
                }

            });
            chrome.storage.sync.get(["mainTicket"], (data) => {
                if (data.mainTicket) {
                    mainTicket.value = data.mainTicket;
                }
            });

        });

        function getTestCase() {
            // to parse the raw generated test case to four section (name, pre-condition, testStep, expectedResult)
            let splitText, testCaseText, preConditionSplit, testStepSplit, expectedResultSplit;
            if (inputText.includes("Name:") || inputText.includes("Name：")) {
                splitText = inputText.split(/(?:\d+\.\s)?(?:Name[:：])/).slice(1);
                if (splitText.length > 0) {
                    splitText.forEach(paragraph => {
                        testCaseText = paragraph;
                        preConditionSplit = testCaseText.split(/(?:Pre-Condition[:：])/);
                        testStepSplit = preConditionSplit[1].split(/(?:Test Steps?[:：])/);
                        expectedResultSplit = testStepSplit[1].split(/(?:Expected Result[:：])/);

                        // to remove the warning words from GPT
                        let expectedResult = expectedResultSplit[1].trim();
                        if (expectedResult.includes('\n\n')) {
                            expectedResult = expectedResult.split('\n\n')[0];
                        }

                        const testCase = {
                            name: preConditionSplit[0].trim(),
                            preCondition: testStepSplit[0].trim(),
                            testStep: expectedResultSplit[0].trim(),
                            expectedResult: expectedResult
                        };
                        testCases.value.push(testCase);
                    }
                    )
                }
            }

        }

        function selectTestCase(index: number) {
            // Implement the logic for selecting a task
            selectedTestCase.value = index;
            const testCase = testCases.value[index];
            if (testCase) {
                name.value = testCase.name;
                preCondition.value = testCase.preCondition;
                testStep.value = testCase.testStep;
                expectedResult.value = testCase.expectedResult;
            }

        }


        function createTask() {
            // Implement the logic for creating a task using the form data
            chrome.storage.sync.get("formData", (data) => {
                if (data.formData) {
                    const formDataString = data.formData;
                    if (formDataString) {
                        const formData = JSON.parse(formDataString);
                        isCreateLoading.value = true;
                        chrome.storage.sync.set({ "isCreateLoading": true });
                        const projectGid = '1203880491753826';  //master script
                        chrome.storage.sync.get(['asanaApiKey'], (data) => {
                            const asanaApiKey = data.asanaApiKey;
                            createAsanaTask(formData, projectGid, asanaApiKey)
                                .then(task_url => {
                                    taskUrl.value = task_url.task_url;
                                    chrome.storage.sync.set({ taskUrl: taskUrl.value });
                                    isCreateLoading.value = false;
                                    chrome.storage.sync.set({ "isCreateLoading": false });
                                })
                                .catch(error => {
                                    // Handle error
                                    console.log(error);
                                });
                        })
                    } else {
                        console.error("No formData found in localStorage");
                    };
                }
            });

        }
        function clearLocalStorage() {
            // Clear the form data from chrome.storage.sync and reset the value to default value
            chrome.storage.sync.remove('taskUrl')
            chrome.storage.sync.remove('formData')
            chrome.storage.sync.set({ "isCreateLoading": false });
            taskUrl.value = null;
            defaultValue();
        }

        function defaultValue() {
            // Reset the value to default value
            name.value = '';
            caseSuite.value = [];
            manualTestCoverage.value = 'Partial';
            preCondition.value = '';
            testStep.value = '';
            expectedResult.value = '';
            manualTestEnvironment.value = 'STAGE';
            caseSource.value = 'Defect';
            mainTicket.value = '';
            generatedBy.value = 'AI';
            isCreateLoading.value = false;
        }

        // Watch for changes to reactive properties and update formData real time
        watch([name, caseSuite, manualTestCoverage, preCondition, testStep, expectedResult, manualTestEnvironment, caseSource, mainTicket, generatedBy], () => {
            const updatedFormData = {
                name: name.value,
                caseSuite: caseSuite.value,
                manualTestCoverage: manualTestCoverage.value,
                preCondition: preCondition.value,
                testStep: testStep.value,
                expectedResult: expectedResult.value,
                manualTestEnvironment: manualTestEnvironment.value,
                caseSource: caseSource.value,
                mainTicket: mainTicket.value,
                generatedBy: generatedBy.value,
            };
            chrome.storage.sync.set({ formData: JSON.stringify(updatedFormData) });
        });

        // Watch the taskUrl property for changes and update localStorage
        watch(taskUrl, (newValue) => {
            chrome.storage.sync.set({ taskUrl: newValue || '' });
        });

        return {
            name,
            caseSuite,
            manualTestCoverage,
            preCondition,
            expectedResult,
            testStep,
            manualTestEnvironment,
            caseSource,
            mainTicket,
            generatedBy,
            caseSuiteOptions,
            manualTestCoverageOptions,
            manualTestEnvironmentOptions,
            caseSourceOptions,
            generatedByOptions,
            createTask,
            taskUrl,
            clearLocalStorage,
            selectedTestCase,
            testCases,
            selectTestCase,
            isCreateLoading
        };
    }
})

</script>
<style scoped>
textarea {
    width: 100%;
    white-space: pre-line;
    word-wrap: break-word;
}

input {
    width: 100%;
}

.form-field {
    padding-bottom: 10px;
}

.button-container {
    display: flex;
    justify-content: space-between;
}

.required-star {
    color: red;
    margin-left: 2px;
}

.active-button {
    /* Set your desired color for the active button */
    background-color: #007bff;
    /* Change this to your desired color */
    color: white;
    /* Change this to your desired text color */
}

.test-case-button {
    margin-top: 10px;
    /* Change this value as per your needs */
}
</style>
<style src="@vueform/multiselect/themes/default.css"></style>
